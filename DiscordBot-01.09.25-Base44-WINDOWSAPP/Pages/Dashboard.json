import React, { useState, useEffect } from "react";
import { Game } from "@/entities/Game";
import { Gamepad2, Star, Trophy } from "lucide-react";
import StatsCard from "../components/dashboard/StatsCard";
import PlatformChart from "../components/dashboard/PlatformChart";
import RecentGames from "../components/dashboard/RecentGames";
import TopRatedGames from "../components/dashboard/TopRatedGames";

export default function Dashboard() {
  const [games, setGames] = useState([]);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    loadGames();
  }, []);

  const loadGames = async () => {
    setIsLoading(true);
    try {
      const data = await Game.list("-created_date");
      setGames(data);
    } catch (error) {
      console.error("Error loading games:", error);
    }
    setIsLoading(false);
  };

  const getStats = () => {
    const total = games.length;
    const newThisMonth = games.filter(g => new Date(g.created_date) > new Date(new Date().setDate(new Date().getDate() - 30))).length;
    const psPlus = games.filter(g => g.piattaforma === "PS Plus").length;
    const xboxPass = games.filter(g => g.piattaforma === "Xbox Game Pass").length;
    const primeGaming = games.filter(g => g.piattaforma === "Prime Gaming").length;
    
    return { total, newThisMonth, psPlus, xboxPass, primeGaming };
  };

  const stats = getStats();

  return (
    <div className="space-y-6">
      <h1 className="text-3xl font-bold text-foreground">Dashboard</h1>

      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
        <StatsCard title="Totale Giochi" value={stats.total} icon={Gamepad2} />
        <StatsCard title="Nuovi questo mese" value={stats.newThisMonth} icon={Trophy} />
        <StatsCard title="PS Plus" value={stats.psPlus} icon={Gamepad2} />
        <StatsCard title="Xbox Game Pass" value={stats.xboxPass} icon={Gamepad2} />
        <StatsCard title="Prime Gaming" value={stats.primeGaming} icon={Gamepad2} />
      </div>

      <div className="grid lg:grid-cols-3 gap-6">
        <div className="lg:col-span-2">
          <RecentGames games={games.slice(0, 7)} isLoading={isLoading} />
        </div>
        <div>
          <PlatformChart games={games} isLoading={isLoading} />
        </div>
      </div>
    </div>
  );
}